<!DOCTYPE html>
<html>
<head>
    <title>require.js: Context Cache Test</title>
    <script type="text/javascript" src="../../require.js"></script>
    <script type="text/javascript" src="../doh/runner.js"></script>
    <script type="text/javascript" src="../doh/_browserRunner.js"></script>
    <script type="text/javascript">
	var doneCount = 0;
	var master = new doh.Deferred();
	function done() {
	    doneCount += 1;
	    //alert("done");
	    if (doneCount === 2) {
		//Make sure there are only one script tag for each module
                var scripts = document.getElementsByTagName("script"),
                    i, counts = {}, modName, prop;
                for (var i = scripts.length - 1; i > -1; i--) {
                    modName = scripts[i].getAttribute("data-requiremodule");
                    if (modName) {
                        if (!(modName in counts)) {
                            counts[modName] = 0;
                        }
                        counts[modName] += 1;
                    }
                }

                //Now that we counted all the modules make sure count
                //is always one, except for special, which is fetched twice,
                //but with a different URL.
                for (prop in counts) {
                    doh.is(prop === 'greek/special' ? 2 : 1, counts[prop]);
                }

		master.callback(true);
	    }
	}
	doh.register(
	    "contextCache",
	    [
		{
		    name: "contextCache",
		    timeout: 5000,
		    runTest: function() {
			require(
			    {
				context: "uno",
				baseUrl: "./",
                                packages: ["greek"]
			    },
			    ["require", "greek/alpha", "greek/beta"],
			    function(require, alpha, beta) {
				doh.is('alpha', alpha.name);
				doh.is('beta', beta.name);

				setTimeout(function(){
				    require(
					["greek/omega", "greek/special"],
					function(omega, special) {
					    doh.is('omega', omega.name);
                                            doh.is('special', special.name);
					    done();
					}
				    );
				}, 100);
			    }
			);

			require(
			    {
				context: "dos",
				baseUrl: "./",
                                paths: {
                                    "greek/special": "special2"
                                },
                                packages: ["greek"]
			    },
			    ["require", "greek/alpha", "greek/beta"],
			    function(require, alpha, beta) {
				doh.is('alpha', alpha.name);
				doh.is('beta', beta.name);

				setTimeout(function(){
				    require(
					["greek/omega", "greek/special"],
					function(omega, special) {
					    doh.is('omega', omega.name);
                                            doh.is('special2', special.name);
					    done();
					}
				    );
				}, 100);
			    }
			);

			return master;
		    }
		}
	    ]
	);
	doh.run();
    </script>
</head>
<body>
    <h1>require.js: Context Cache Test</h1>
    
    <p>Check console for messages.</p>
    
    <p>This test creates two different contexts but should reuse the module define
    args, so the modules are only fetched once. One module will be fetched from a different
    path, to make sure two different calls are made.</p>
</body>
</html>
