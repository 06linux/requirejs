<!DOCTYPE html>
<html>
<head>
    <title>run.js: After Load</title>
    <script type="text/javascript" src="doh/runner.js"></script>
    <script type="text/javascript" src="doh/_browserRunner.js"></script>
    <script type="text/javascript">
    var d;

    function goRun() {
        //Need a hack to trigger run.pageLoaded() for pre Firefox 3.6 browsers.
        var ff = parseFloat(navigator.userAgent.split("Firefox/")[1]) || null;
        if (ff && ff < 3.6) {
            run.pageLoaded();
        }

        run({
                baseUrl: "./"
            },
            ["run", "simple"],
            function (run, simple) {
                run.ready(function() {
                    doh.is("blue", simple.color);
                    d.callback(true);
                });
            }
        );
    }

    function loadRun() {
        var s, head, readyRegExp = /complete|loaded/;
        function onScriptLoad(evt) {
            var node = evt.target || evt.srcElement;
            if (evt.type === "load" || readyRegExp.test(node.readyState)) {
                //Clean up script binding, otherwise, Opera in particular
                //may trigger it again.
                if (node.removeEventListener) {
                    node.removeEventListener("load", onScriptLoad, false);
                } else {
                    //Probably IE.
                    node.detachEvent("onreadystatechange", onScriptLoad);
                }
                goRun();
            }
        };

        //Create script tag for run.js
        s = document.createElement("script");
        s.src = "../run.js";
        s.charset = "utf-8";

        //Set up load listener.
        if (s.addEventListener) {
            s.addEventListener("load", onScriptLoad, false);
        } else {
            //Probably IE.
            s.attachEvent("onreadystatechange", onScriptLoad);
        }

        head = (document.getElementsByTagName("head")[0] ||
                document.getElementsByTagName("html")[0]);
        head.appendChild(s);
    }

    doh.register(
        "afterload",
        [
            {
                name: "afterload",
                timeout: 5000,
                runTest: function() {
                    d = new doh.Deferred();
                    return d;
                }
            }
        ]
    );
    doh.run();


    /*}
    run({
            baseUrl: "./"    
        },
        ["run", "simple", "dimple"],
        function(run, simple, dimple) {
            run.ready(function(){
                doh.register(
                    "simple", 
                    [
                        function colors(t){
                            t.is("blue", simple.color);
                            t.is("dimple-blue", dimple.color);
                        }
                    ]
                );
                doh.run();			
            });
        }
    );
    */
    </script>
</head>
<body onload="loadRun()">
    <h1>run.js: After Load Test</h1>
    <p>Tests adding run after the page loads. Test will fail in Firefox 3.5 and
    earlier, but Firefox 3.6+ will work.</p>
    <p>Check console for messages</p>
</body>
</html>
