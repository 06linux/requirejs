<!DOCTYPE html>
<html>
<head>
    <title>Script noload Test</title>
    <script src="../common.js"></script>
    <script>

    var readyRegExp = /complete|loaded/;

    function onTestScriptLoad(evt) {
        var node = evt.target || evt.srcElement;
        if (evt.type === "load" || readyRegExp.test(node.readyState)) {
            log(node.getAttribute("data-name") + " loaded");

            //Clean up binding.
            if (node.removeEventListener) {
                node.removeEventListener("load", onTestScriptLoad, false);
            } else {
                //Probably IE.
                node.detachEvent("onreadystatechange", onTestScriptLoad);
            }
        }
    }

    function onTestError(evt) {
        var node = evt.target || evt.srcElement,
            name = node.getAttribute("data-name");

        if (typeof console !== "undefined" && console.log) {
            console.log(name + ' has error event: ', evt);
        }

        log(name + " onerror triggered");

        //Clean up binding.
        if (node.removeEventListener) {
            node.removeEventListener("error", onTestError, false);
        } else {
            //Probably IE.
            node.detachEvent("onerror", onTestError);
        }
    }

    function attachScript(url, name) {
        var node = document.createElement("script");
        node.src = url;
        node.type = "text/javascript";
        node.charset = "utf-8";
        node.setAttribute("data-name", name);

        //Set up load listener.
        if (node.addEventListener) {
            node.addEventListener("load", onTestScriptLoad, false);
            node.addEventListener("error", onTestError, false);
        } else {
            //Probably IE.
            node.attachEvent("onreadystatechange", onTestScriptLoad);
            node.attachEvent("onerror", onTestError);
        }

        document.getElementsByTagName("head")[0].appendChild(node);
    }

    //Main logic
    attachScript('404.js', '404');

    attachScript('200.js', '200');

    var url505 = location.protocol + '//' + location.hostname + ':9320/505.js';
    attachScript(url505, '505');

    var noServerUrl = location.protocol + '//' + location.hostname + ':9321/noserver.js';
    attachScript(noServerUrl, 'no server');
    </script>
</head>
<body>
    <h1>Script noload Test</h1>

    <p>Test if HTTP 404 or 500 calls or down hosts for a script trigger a scripts error handler.</p>

    <p>For this test to receive 500 responses, nodejs needs to run server.js in this directory.</p>

    <p>Output below should be "404 onerror triggered", "500 onerror triggered" and "no server onerror triggered".
    They may be in a different order, but that is OK.</p>

    <p>Unfortunately, IE 6-8 trigger the onreadystate callback, <b>not the error callback</b>,
    and given that they execute scripts in a way where the onload for a script is not executed
    <b>immediately</b> after executing the script, we do not have a good way to determine if
    the onreadystate 'load' was for the non-loading script or for a good one.</p>

    <p>If all scripts called define() then the loader would have a chance to determine if
    the module was not already loaded or in the context.defQueue (in requirejs). However,
    since some scripts can be executed in requirejs without using define, there does not
    seem to be a reliable way to tie the error to the event.</p>

</body>
</html>
